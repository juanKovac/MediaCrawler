# 版本管理指南

本文档介绍 RedNoteAnalyzer 项目的版本管理系统使用方法。

## 📋 目录

- [概述](#概述)
- [版本控制规范](#版本控制规范)
- [工具使用](#工具使用)
- [发布流程](#发布流程)
- [Git钩子](#git钩子)
- [常见问题](#常见问题)

## 🎯 概述

本项目采用语义化版本控制（Semantic Versioning），结合自动化工具实现规范的版本管理。

### 版本号格式

```
主版本号.次版本号.修订号
例如: 1.2.3
```

- **主版本号**：不兼容的API修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

### 文件结构

```
RedNoteAnalyzer/
├── version.json          # 版本配置文件
├── CHANGELOG.md          # 版本变更日志
├── pyproject.toml        # 项目配置（包含版本信息）
└── scripts/
    ├── version_manager.py    # 版本管理工具
    ├── release.py           # 发布管理工具
    └── setup_git_hooks.py   # Git钩子设置工具
```

## 📝 版本控制规范

### 提交信息格式

```
<type>(<scope>): <description>

[optional body]

[optional footer]
```

#### 类型说明

| 类型 | 说明 | 版本影响 |
|------|------|----------|
| `feat` | 新功能 | minor |
| `fix` | 修复bug | patch |
| `docs` | 文档更新 | patch |
| `style` | 代码格式调整 | patch |
| `refactor` | 代码重构 | patch |
| `test` | 测试相关 | patch |
| `chore` | 构建/工具相关 | patch |
| `breaking` | 破坏性变更 | major |

#### 示例

```bash
# 新功能
feat: 添加小红书数据爬取功能
feat(auth): 添加OAuth2认证支持

# 修复bug
fix: 修复数据库连接超时问题
fix(crawler): 修复爬虫重试机制

# 文档更新
docs: 更新API文档
docs(readme): 添加安装说明

# 破坏性变更
breaking: 重构API接口，不兼容旧版本
```

## 🛠️ 工具使用

### 版本管理工具 (version_manager.py)

#### 查看当前版本

```bash
python scripts/version_manager.py --current
```

#### 手动更新版本

```bash
# 更新主版本号
python scripts/version_manager.py --bump major

# 更新次版本号
python scripts/version_manager.py --bump minor

# 更新修订号
python scripts/version_manager.py --bump patch

# 添加描述
python scripts/version_manager.py --bump minor --description "添加新的数据分析功能"
```

#### 自动更新版本

```bash
# 根据最新提交信息自动判断版本类型
python scripts/version_manager.py --auto
```

#### 创建Git标签

```bash
# 为当前版本创建标签
python scripts/version_manager.py --tag

# 更新版本并创建标签
python scripts/version_manager.py --bump minor --tag
```

### 发布管理工具 (release.py)

#### 查看发布信息

```bash
python scripts/release.py --info
```

#### 准备发布（不创建标签）

```bash
python scripts/release.py --prepare --type minor
```

#### 完整发布流程

```bash
# 手动指定版本类型
python scripts/release.py --type minor --description "添加新功能"

# 自动判断版本类型
python scripts/release.py --auto

# 发布但不推送到远程
python scripts/release.py --type patch --no-push
```

### Git钩子设置 (setup_git_hooks.py)

#### 安装Git钩子

```bash
python scripts/setup_git_hooks.py --install
```

#### 检查钩子状态

```bash
python scripts/setup_git_hooks.py --status
```

#### 移除Git钩子

```bash
python scripts/setup_git_hooks.py --remove
```

## 🚀 发布流程

### 标准发布流程

1. **开发完成**
   ```bash
   # 确保所有更改已提交
   git status
   ```

2. **检查发布信息**
   ```bash
   python scripts/release.py --info
   ```

3. **执行发布**
   ```bash
   # 自动发布（推荐）
   python scripts/release.py --auto
   
   # 或手动指定类型
   python scripts/release.py --type minor --description "添加新功能"
   ```

4. **验证发布**
   ```bash
   # 检查标签
   git tag -l
   
   # 检查远程仓库
   git log --oneline -5
   ```

### 紧急修复发布

```bash
# 1. 创建修复分支
git checkout -b hotfix/fix-critical-bug

# 2. 修复问题并提交
git add .
git commit -m "fix: 修复关键安全漏洞"

# 3. 合并到主分支
git checkout main
git merge hotfix/fix-critical-bug

# 4. 发布修复版本
python scripts/release.py --type patch --description "紧急修复安全漏洞"

# 5. 删除修复分支
git branch -d hotfix/fix-critical-bug
```

## 🔧 Git钩子

项目包含以下Git钩子：

### pre-commit
- 检查Python语法
- 检查代码风格（如果安装了flake8）
- 检查大文件（>10MB）

### commit-msg
- 验证提交信息格式
- 确保符合约定式提交规范

### pre-push
- 检查未提交的更改
- 运行测试（如果存在）
- 检查版本一致性

## ❓ 常见问题

### Q: 如何回滚版本？

A: 可以通过以下方式回滚：

```bash
# 回滚到指定版本
git checkout v1.2.3

# 创建新分支进行修复
git checkout -b rollback-fix

# 或者直接重置到指定提交
git reset --hard <commit-hash>
```

### Q: 如何修改已发布的版本信息？

A: 不建议修改已发布的版本，但可以：

1. 删除错误的标签：
   ```bash
   git tag -d v1.2.3
   git push origin :refs/tags/v1.2.3
   ```

2. 重新创建正确的版本

### Q: 版本号不一致怎么办？

A: 运行以下命令同步版本：

```bash
# 检查当前版本状态
python scripts/release.py --info

# 手动同步版本号
python scripts/version_manager.py --current
```

### Q: Git钩子不工作怎么办？

A: 检查钩子状态和权限：

```bash
# 检查钩子状态
python scripts/setup_git_hooks.py --status

# 重新安装钩子
python scripts/setup_git_hooks.py --remove
python scripts/setup_git_hooks.py --install
```

### Q: 如何跳过Git钩子？

A: 在特殊情况下可以跳过钩子：

```bash
# 跳过pre-commit钩子
git commit --no-verify -m "紧急修复"

# 跳过pre-push钩子
git push --no-verify
```

**注意：不建议经常跳过钩子，这会降低代码质量。**

## 📚 参考资料

- [语义化版本控制](https://semver.org/lang/zh-CN/)
- [约定式提交](https://www.conventionalcommits.org/zh-hans/)
- [Git钩子文档](https://git-scm.com/book/zh/v2/自定义-Git-Git-钩子)
- [Keep a Changelog](https://keepachangelog.com/zh-CN/)

---

如有问题，请查看项目文档或提交Issue。